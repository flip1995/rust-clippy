#![allow(dead_code)]
#![feature(allocator_api)]

use std::alloc::{Layout, AllocError, Allocator};
use std::ptr::NonNull;

struct SizedStruct(i32);
struct UnsizedStruct([i32]);
struct BigStruct([i32; 10000]);

struct DummyAllocator;
unsafe impl Allocator for DummyAllocator {
    fn allocate(&self, layout: Layout) -> Result<NonNull<[u8]>, AllocError> {
        todo!()
    }
    unsafe fn deallocate(&self, ptr: NonNull<u8>, layout: Layout) {
        todo!()
    }
}

/// The following should trigger the lint
mod should_trigger {
    use super::{SizedStruct, DummyAllocator};
    const C: Vec<i32> = Vec::new();
    static S: Vec<i32> = Vec::new();

    struct StructWithVecBox {
        sized_type: Vec<SizedStruct>,
    }

    struct A(Vec<SizedStruct>);
    struct B(Vec<Vec<u32>>);

    fn allocator_global_defined_vec() -> Vec<i32> {
        Vec::new()
    }
    fn allocator_global_defined_box() -> Vec<i32> {
        Vec::new()
    }
    fn allocator_match() -> Vec<i32> {
        Vec::new_in(DummyAllocator)
    }
}

/// The following should not trigger the lint
mod should_not_trigger {
    use super::{BigStruct, UnsizedStruct, DummyAllocator};

    struct C(Vec<Box<UnsizedStruct>>);
    struct D(Vec<Box<BigStruct>>);

    struct StructWithVecBoxButItsUnsized {
        unsized_type: Vec<Box<UnsizedStruct>>,
    }

    struct TraitVec<T: ?Sized> {
        // Regression test for #3720. This was causing an ICE.
        inner: Vec<Box<T>>,
    }

    fn allocator_mismatch() -> Vec<Box<i32, DummyAllocator>> {
        Vec::new()
    }
}

mod inner_mod {
    mod inner {
        pub struct S;
    }

    mod inner2 {
        use super::inner::S;

        pub fn f() -> Vec<S> {
            vec![]
        }
    }
}

// https://github.com/rust-lang/rust-clippy/issues/11417
fn in_closure() {
    let _ = |_: Vec<Box<dyn ToString>>| {};
}

fn main() {}
